Modbus 通信协议是一种串行通信协议，最初由 Modicon 公司（现为施耐德电气）于 1979 年开发，用于其可编程逻辑控制器 (PLC)。它已经发展成为工业自动化领域事实上的标准协议，用于连接各种工业电子设备。

**Modbus 协议的变体：**

1.  **Modbus RTU (Remote Terminal Unit):**
    *   最常用的 Modbus 变体。
    *   使用二进制格式进行数据传输，效率较高。
    *   通常通过 RS-232 或 RS-485 串行接口进行通信。
    *   使用 CRC (循环冗余校验) 进行错误检测。

2.  **Modbus ASCII:**
    *   使用 ASCII 字符进行数据传输，可读性较好，但效率较低。
    *   通常通过 RS-232 或 RS-485 串行接口进行通信。
    *   使用 LRC (纵向冗余校验) 进行错误检测。

3.  **Modbus TCP:**
    *   将 Modbus 协议封装在 TCP/IP 协议中，通过以太网进行通信。
    *   使用标准的 TCP 端口 502。
    *   不需要校验和，因为 TCP/IP 协议已经提供了可靠的数据传输。

**Modbus 通信模型：**

*   **主从模式 (Master-Slave):** Modbus 通信始终由一个主设备 (Master) 发起，一个或多个从设备 (Slave) 响应。
    *   主设备：通常是 PLC、HMI (人机界面) 或 SCADA 系统。
    *   从设备：通常是传感器、执行器、仪表或其他 PLC。
    *   主设备发送请求，从设备根据请求执行相应的操作并返回响应。
    *   一个 Modbus 网络中只能有一个主设备，但可以有多个从设备 (最多 247 个，使用 Modbus RTU/ASCII)。

**Modbus 数据模型：**

Modbus 定义了四种基本的数据类型：

| 数据类型     | 描述                   | 访问权限 |
| ------------ | ---------------------- | -------- |
| 离散输入     | 单个位 (bit)，只读     | 只读     |
| 线圈 (Coils) | 单个位 (bit)，可读可写 | 读/写    |
| 输入寄存器   | 16 位 (word)，只读     | 只读     |
| 保持寄存器   | 16 位 (word)，可读可写 | 读/写    |

*   每种数据类型都有一个地址范围 (0-65535)。
*   从设备根据主设备的请求，访问或修改相应地址的数据。

**Modbus 功能码：**

Modbus 使用功能码来定义主设备请求的操作类型。以下是一些常用的功能码：

| 功能码 | 描述             | 数据类型   |
| ------ | ---------------- | ---------- |
| 0x01   | 读线圈           | 线圈       |
| 0x02   | 读离散输入       | 离散输入   |
| 0x03   | 读保持寄存器     | 保持寄存器 |
| 0x04   | 读输入寄存器     | 输入寄存器 |
| 0x05   | 写单个线圈       | 线圈       |
| 0x06   | 写单个保持寄存器 | 保持寄存器 |
| 0x0F   | 写多个线圈       | 线圈       |
| 0x10   | 写多个保持寄存器 | 保持寄存器 |

**Modbus 报文格式 (以 Modbus RTU 为例):**

Modbus RTU 报文由以下几个部分组成：

1.  **从设备地址 (1 字节):** 指定目标从设备的地址 (1-247)。地址 0 用于广播消息。
2.  **功能码 (1 字节):** 指定请求的操作类型。
3.  **数据 (可变长度):** 包含请求或响应的数据。
    *   对于读请求，数据通常包含起始地址和要读取的数据数量。
    *   对于写请求，数据包含要写入的数据。
4.  **CRC 校验 (2 字节):** 使用 CRC-16 算法计算的校验和，用于检测传输错误。

**Modbus RTU 请求报文示例 (读取保持寄存器):**

假设要从从设备地址为 1 的设备读取从地址 0 开始的 2 个保持寄存器 (功能码 0x03)：

| 从设备地址 | 功能码 | 起始地址 (高字节) | 起始地址 (低字节) | 寄存器数量 (高字节) | 寄存器数量 (低字节) | CRC (低字节) | CRC (高字节) |
| ---------- | ------ | ----------------- | ----------------- | ------------------- | ------------------- | ------------ | ------------ |
| 0x01       | 0x03   | 0x00              | 0x00              | 0x00                | 0x02                | 0xXX         | 0xXX         |

**Modbus RTU 响应报文示例 (读取保持寄存器):**

假设从设备返回的数据为 0x1234 和 0x5678：

| 从设备地址 | 功能码 | 字节数 | 数据 1 (高字节) | 数据 1 (低字节) | 数据 2 (高字节) | 数据 2 (低字节) | CRC (低字节) | CRC (高字节) |
| ---------- | ------ | ------ | --------------- | --------------- | --------------- | --------------- | ------------ | ------------ |
| 0x01       | 0x03   | 0x04   | 0x12            | 0x34            | 0x56            | 0x78            | 0xXX         | 0xXX         |

**Modbus 异常响应:**

如果从设备无法执行请求的操作，它会返回一个异常响应。异常响应报文的格式如下：

| 从设备地址 | 功能码 (最高位为 1) | 异常码 | CRC (低字节) | CRC (高字节) |
| ---------- | ------------------- | ------ | ------------ | ------------ |
| 0x01       | 0x83                | 0x02   | 0xXX         | 0xXX         |

*   功能码的最高位被设置为 1，表示这是一个异常响应。
*   异常码指示错误的类型。

**常用异常码:**

| 异常码 | 描述         |
| ------ | ------------ |
| 0x01   | 非法功能码   |
| 0x02   | 非法数据地址 |
| 0x03   | 非法数据值   |
| 0x04   | 从设备故障   |

